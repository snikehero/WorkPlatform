-- Legacy asset assignment import map (generated from it_equipment (1).sql)
-- Source date in dump header: 2026-02-18
-- Target DB: PostgreSQL / workplatform
--
-- What this script does:
-- 1) Loads legacy mapping (asset_tag + legacy userid + legacy person name) into a temp table
-- 2) PREVIEW (dump) how each asset tag maps to a current person
-- 3) Updates assets.user_name and assets.assigned_to
--
-- Matching priority against current people table:
--   a) people.legacy_id = legacy_user_id
--   b) normalized people.name = normalized legacy_user_name
--
-- Unmatched assets are set to 'Unassigned'.

BEGIN;

CREATE TEMP TABLE legacy_asset_assignments (
  asset_tag TEXT PRIMARY KEY,
  legacy_user_id INTEGER,
  legacy_user_name TEXT
);

INSERT INTO legacy_asset_assignments (asset_tag, legacy_user_id, legacy_user_name) VALUES
  ('TDC-0001', 84, 'SANCHEZ HERNANDEZ LUIS ALFREDO'),
  ('TDC-0002', 82, 'SANCHEZ DOMINGUEZ VICTOR HUGO'),
  ('TDC-0003', 68, 'PALOMEC LOYOLA FRANCISCO JAVIER'),
  ('TDC-0004', 10, 'BARBOSA ORTIZ JOSE DE JESUS'),
  ('TDC-0005', 29, 'CRUZ GARCIA IVAN ALBERTO'),
  ('TDC-0006', 85, 'SANCHEZ LOPEZ MOISES'),
  ('TDC-0007', 28, 'COLUNGA AARON'),
  ('TDC-0008', 24, 'CASTRO TOVAR JENNIFER'),
  ('TDC-0009', 85, 'SANCHEZ LOPEZ MOISES'),
  ('TDC-0010', 24, 'CASTRO TOVAR JENNIFER'),
  ('TDC-0011', 38, 'GONZALEZ ANGELES EDGAR'),
  ('TDC-0012', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0013', 24, 'CASTRO TOVAR JENNIFER'),
  ('TDC-0014', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0015', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0016', 70, 'PONCE RODRIGUEZ HECTOR MIGUEL'),
  ('TDC-0017C', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0018', 14, 'BRIONES PALACIOS ELIAS FERNANDO'),
  ('TDC-0019', 14, 'BRIONES PALACIOS ELIAS FERNANDO'),
  ('TDC-0021', 74, 'ROBLEDO SIERRA ANIELA ESTEFANIA'),
  ('TDC-0020', 8, 'BADILLO MARTINEZ DAVID RAYMUNDO'),
  ('TDC-0022', 25, 'CERVANTES RODRIGUEZ LUIS EDUARDO'),
  ('TDC-0023', 74, 'ROBLEDO SIERRA ANIELA ESTEFANIA'),
  ('TDC-0024', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0025', 36, 'GARCIA VARGAS PAOLA JAQUELYN'),
  ('TDC-0026', 46, 'HERNANDEZ MARQUEZ URIEL'),
  ('TDC-0027', 74, 'ROBLEDO SIERRA ANIELA ESTEFANIA'),
  ('TDC-0028', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0029', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0030', 14, 'BRIONES PALACIOS ELIAS FERNANDO'),
  ('TDC-0031', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0032', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0033', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0034', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0035', 22, 'CASTAÑEDA ARTEAGA FLOR CAROLINA'),
  ('TDC-0036', 22, 'CASTAÑEDA ARTEAGA FLOR CAROLINA'),
  ('TDC-0037', 67, 'PADILLA IGLESIAS FREDY JOEL'),
  ('TDC-0038', 82, 'SANCHEZ DOMINGUEZ VICTOR HUGO'),
  ('TDC-0039', 67, 'PADILLA IGLESIAS FREDY JOEL'),
  ('TDC-0040', 77, 'RODRIGUEZ ISAIS PAOLA BETHSABE'),
  ('TDC-0041', 32, 'GARCIA HUERTA LUIS HORACIO'),
  ('TDC-0042', 79, 'RUEDA LOREDO AMERICA'),
  ('TDC-0043', 79, 'RUEDA LOREDO AMERICA'),
  ('TDC-0044', 79, 'RUEDA LOREDO AMERICA'),
  ('TDC-0045', 79, 'RUEDA LOREDO AMERICA'),
  ('TDC-0046', 40, 'GUTIERREZ AMADOR DYANA'),
  ('TDC-0047', 40, 'GUTIERREZ AMADOR DYANA'),
  ('TDC-0048', 40, 'GUTIERREZ AMADOR DYANA'),
  ('TDC-0049', 40, 'GUTIERREZ AMADOR DYANA'),
  ('TDC-0050', 40, 'GUTIERREZ AMADOR DYANA'),
  ('TDC-0051', 55, 'MEDINA GAMEZ LILIAN GABRIELA'),
  ('TDC-0052', 11, 'BARRERA FLORES BEATRIZ ARACELI'),
  ('TDC-0053', 11, 'BARRERA FLORES BEATRIZ ARACELI'),
  ('TDC-0054', 11, 'BARRERA FLORES BEATRIZ ARACELI'),
  ('TDC-0055', 11, 'BARRERA FLORES BEATRIZ ARACELI'),
  ('TDC-0056', 72, 'RAMIREZ TORRES EMMANUEL DE JESUS'),
  ('TDC-0057', 87, 'VENTURA PAULIN REYNA GUADALUPE'),
  ('TDC-0058', 72, 'RAMIREZ TORRES EMMANUEL DE JESUS'),
  ('TDC-0059', 87, 'VENTURA PAULIN REYNA GUADALUPE'),
  ('TDC-0060', 87, 'VENTURA PAULIN REYNA GUADALUPE'),
  ('TDC-0061', 87, 'VENTURA PAULIN REYNA GUADALUPE'),
  ('TDC-0062', 0, ''),
  ('TDC-0063', 72, 'RAMIREZ TORRES EMMANUEL DE JESUS'),
  ('TDC-0064', 0, ''),
  ('TDC-0065', 0, ''),
  ('TDC-0066', 0, ''),
  ('TDC-0067', 0, ''),
  ('TDC-0068', 0, ''),
  ('TDC-0069', 11, 'BARRERA FLORES BEATRIZ ARACELI'),
  ('TDC-0070', 11, 'BARRERA FLORES BEATRIZ ARACELI'),
  ('TDC-0071', 32, 'GARCIA HUERTA LUIS HORACIO'),
  ('TDC-0072', 11, 'BARRERA FLORES BEATRIZ ARACELI'),
  ('TDC-0073', 11, 'BARRERA FLORES BEATRIZ ARACELI'),
  ('TDC-0074', 11, 'BARRERA FLORES BEATRIZ ARACELI'),
  ('TDC-0075', 11, 'BARRERA FLORES BEATRIZ ARACELI'),
  ('TDC-0076', 84, 'SANCHEZ HERNANDEZ LUIS ALFREDO'),
  ('TDC-0077', 84, 'SANCHEZ HERNANDEZ LUIS ALFREDO'),
  ('TDC-0078', 84, 'SANCHEZ HERNANDEZ LUIS ALFREDO'),
  ('TDC-0079', 84, 'SANCHEZ HERNANDEZ LUIS ALFREDO'),
  ('TDC-0080', 77, 'RODRIGUEZ ISAIS PAOLA BETHSABE'),
  ('TDC-0081', 10, 'BARBOSA ORTIZ JOSE DE JESUS'),
  ('TDC-0082', 30, 'DIAZ ZAPATA MARTHA LAURA'),
  ('TDC-0083', 10, 'BARBOSA ORTIZ JOSE DE JESUS'),
  ('TDC-0085', 10, 'BARBOSA ORTIZ JOSE DE JESUS'),
  ('TDC-0084', 30, 'DIAZ ZAPATA MARTHA LAURA'),
  ('TDC-0086', 10, 'BARBOSA ORTIZ JOSE DE JESUS'),
  ('TDC-0087', 28, 'COLUNGA AARON'),
  ('TDC-0088', 28, 'COLUNGA AARON'),
  ('TDC-0089', 28, 'COLUNGA AARON'),
  ('TDC-0090', 28, 'COLUNGA AARON'),
  ('TDC-0091', 30, 'DIAZ ZAPATA MARTHA LAURA'),
  ('TDC-0092', 68, 'PALOMEC LOYOLA FRANCISCO JAVIER'),
  ('TDC-0093', 68, 'PALOMEC LOYOLA FRANCISCO JAVIER'),
  ('TDC-0094', 68, 'PALOMEC LOYOLA FRANCISCO JAVIER'),
  ('TDC-0095', 68, 'PALOMEC LOYOLA FRANCISCO JAVIER'),
  ('TDC-0096', 30, 'DIAZ ZAPATA MARTHA LAURA'),
  ('TDC-0098', 84, 'SANCHEZ HERNANDEZ LUIS ALFREDO'),
  ('TDC-0097', 94, 'ACOSTA HERNANDEZ CLAUDIA PATRICIA\r\n'),
  ('TDC-0099', 88, 'ZARATE SANTILLAN IVETT'),
  ('TDC-0100', 88, 'ZARATE SANTILLAN IVETT'),
  ('TDC-0101', 88, 'ZARATE SANTILLAN IVETT'),
  ('TDC-0102', 88, 'ZARATE SANTILLAN IVETT'),
  ('TDC-0103', 88, 'ZARATE SANTILLAN IVETT'),
  ('TDC-0104', 94, 'ACOSTA HERNANDEZ CLAUDIA PATRICIA\r\n'),
  ('TDC-0105', 13, 'BRAVO BRAVO JUANITA NOHEMI'),
  ('TDC-0106', 13, 'BRAVO BRAVO JUANITA NOHEMI'),
  ('TDC-0107', 13, 'BRAVO BRAVO JUANITA NOHEMI'),
  ('TDC-0108', 5, 'ALEMAN MENDIOLA VICTOR ALEJANDRO'),
  ('TDC-0109', 39, 'GONZALEZ HARO JOSE YAEL'),
  ('TDC-0110', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0111', 16, 'BUSTAMENTE CRISTOPHER'),
  ('TDC-0112', 16, 'BUSTAMENTE CRISTOPHER'),
  ('TDC-0113', 0, ''),
  ('TDC-0114', 30, 'DIAZ ZAPATA MARTHA LAURA'),
  ('TDC-0116', 33, 'GARCIA MARQUEZ JOSE ANGEL'),
  ('TDC-0115', 35, 'GARCIA SANTIAGO LUIS ADRIAN'),
  ('TDC-0117', 59, 'MUCIÑO BERNAL GUSTAVO ANGEL'),
  ('TDC-0118', 37, 'GOMEZ TEXCO GELACIO IVAN'),
  ('TDC-0119', 61, 'OLVERA BAUTISTA GUSTAVO ANGEL'),
  ('TDC-0121', 58, 'MORENO VARELA DANIELA'),
  ('TDC-0120', 83, 'SANCHEZ GONZALEZ JESSICA NAYELY'),
  ('TDC-0122', 88, 'ZARATE SANTILLAN IVETT'),
  ('TDC-0123', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0124', 20, 'CARRILLO HARO GERARDO'),
  ('TDC-0125', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0126', 51, 'MARTINEZ ACOSTA ALEXIS AMINADAF'),
  ('TDC-0127', 19, 'CARRASCO VELAZQUEZ LEONARDO DANIEL'),
  ('TDC-0128', 38, 'GONZALEZ ANGELES EDGAR'),
  ('TDC-0129', 2, 'ACOSTA CASTRO GIOVANNI ALEJANDRO'),
  ('TDC-0130', 0, ''),
  ('TDC-0131', 96, 'HERNANDEZ SANCHEZ ERIKA LIZBETH'),
  ('TDC-0132', 17, 'CAMPOS CHOCOTECO HECTOR LEOBARDO'),
  ('TDC-0133', 29, 'CRUZ GARCIA IVAN ALBERTO'),
  ('TDC-0134', 29, 'CRUZ GARCIA IVAN ALBERTO'),
  ('TDC-0135', 19, 'CARRASCO VELAZQUEZ LEONARDO DANIEL'),
  ('TDC-0136', 19, 'CARRASCO VELAZQUEZ LEONARDO DANIEL'),
  ('TDC-0137', 70, 'PONCE RODRIGUEZ HECTOR MIGUEL'),
  ('TDC-0138', 70, 'PONCE RODRIGUEZ HECTOR MIGUEL'),
  ('TDC-0139', 84, 'SANCHEZ HERNANDEZ LUIS ALFREDO'),
  ('TDC-0140', 30, 'DIAZ ZAPATA MARTHA LAURA'),
  ('TDC-0141', 4, 'AGUILAR BANDA JUAN ANGEL'),
  ('TDC-0142', 9, 'BALTAZAR ALVARADO SAMUEL JOAB'),
  ('TDC-0143', 42, 'HERNANDEZ CORONA FELIPE BERNARDO'),
  ('TDC-0144', 10, 'BARBOSA ORTIZ JOSE DE JESUS'),
  ('TDC-0145', 81, 'SALAZAR PEREZ JOEL ABRAHAM'),
  ('TDC-0146', 6, 'APARICIO MONTELONGO ISAMAR'),
  ('TDC-0147', 23, 'CASTAÑEDA MARTINEZ ROBERTO DAMIAN MANUEL'),
  ('TDC-0148', 52, 'MARTINEZ RAMIREZ ERICK ALEJANDRO'),
  ('TDC-0149', 3, 'ACUÑA ROCHA TAHICHA FABIOLA'),
  ('TDC-0150', 5, 'ALEMAN MENDIOLA VICTOR ALEJANDRO'),
  ('TDC-0151', 60, 'NIETO MENDOZA GERARDO'),
  ('TDC-0152', 0, ''),
  ('TDC-0153', 80, 'SALAS CHAVEZ JUAN ESTEBAN'),
  ('TDC-0154', 21, 'CASTAÑEDA ALAN'),
  ('TDC-0155', 32, 'GARCIA HUERTA LUIS HORACIO'),
  ('TDC-0156', 31, 'FLORES SANCHEZ JUAN CARLOS'),
  ('TDC-0157', 18, 'CANCHE LOPEZ JOSE ALBERTO'),
  ('TDC-0158', 41, 'HERNANDEZ CAMPILLO HUGO ALBERTO'),
  ('TDC-0159', 57, 'MORENO BRAVO ARTURO'),
  ('TDC-0160', 56, 'MEJIA MARTINEZ ANA KAREN'),
  ('TDC-0161', 15, 'BRIONES PALACIOS GABRIELA'),
  ('TDC-0162', 21, 'CASTAÑEDA ALAN'),
  ('TDC-0163', 21, 'CASTAÑEDA ALAN'),
  ('TDC-0164', 21, 'CASTAÑEDA ALAN'),
  ('TDC-0165', 21, 'CASTAÑEDA ALAN'),
  ('TDC-0166', 95, 'LARA ORTEGA IMPERIO ESTEPHANIA'),
  ('TDC-0167', 30, 'DIAZ ZAPATA MARTHA LAURA'),
  ('TDC-0168', 30, 'DIAZ ZAPATA MARTHA LAURA'),
  ('TDC-0169', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0170', 11, 'BARRERA FLORES BEATRIZ ARACELI'),
  ('TDC-0171', 73, 'REYES GARCIA JOSUE MANUEL'),
  ('TDC-0172', 80, 'SALAS CHAVEZ JUAN ESTEBAN'),
  ('TDC-0173', 80, 'SALAS CHAVEZ JUAN ESTEBAN'),
  ('TDC-0174', 0, ''),
  ('TDC-0175', 80, 'SALAS CHAVEZ JUAN ESTEBAN');

-- PREVIEW / DUMP: review mapping before applying update
WITH resolved AS (
  SELECT
    l.asset_tag,
    l.legacy_user_id,
    l.legacy_user_name,
    a.id AS current_asset_id,
    p.id AS current_person_id,
    p.name AS current_person_name
  FROM legacy_asset_assignments l
  LEFT JOIN assets a
    ON upper(btrim(a.asset_tag)) = upper(btrim(l.asset_tag))
  LEFT JOIN LATERAL (
    SELECT p2.id, p2.name
    FROM people p2
    WHERE p2.legacy_id = l.legacy_user_id
       OR (btrim(coalesce(l.legacy_user_name, '')) <> ''
           AND lower(btrim(p2.name)) = lower(btrim(l.legacy_user_name)))
    ORDER BY CASE WHEN p2.legacy_id = l.legacy_user_id THEN 0 ELSE 1 END, p2.name
    LIMIT 1
  ) p ON TRUE
)
SELECT
  asset_tag,
  legacy_user_id,
  legacy_user_name,
  current_asset_id,
  current_person_id,
  COALESCE(current_person_name, 'Unassigned') AS mapped_assigned_to
FROM resolved
ORDER BY asset_tag;

-- APPLY UPDATE
WITH resolved AS (
  SELECT
    a.id AS asset_id,
    COALESCE(p.name, 'Unassigned') AS assigned_name
  FROM legacy_asset_assignments l
  JOIN assets a
    ON upper(btrim(a.asset_tag)) = upper(btrim(l.asset_tag))
  LEFT JOIN LATERAL (
    SELECT p2.name
    FROM people p2
    WHERE p2.legacy_id = l.legacy_user_id
       OR (btrim(coalesce(l.legacy_user_name, '')) <> ''
           AND lower(btrim(p2.name)) = lower(btrim(l.legacy_user_name)))
    ORDER BY CASE WHEN p2.legacy_id = l.legacy_user_id THEN 0 ELSE 1 END, p2.name
    LIMIT 1
  ) p ON TRUE
)
UPDATE assets a
SET
  user_name = r.assigned_name,
  assigned_to = r.assigned_name,
  updated_at = NOW()
FROM resolved r
WHERE a.id = r.asset_id;

-- Safety normalization
UPDATE assets
SET
  user_name = 'Unassigned',
  assigned_to = 'Unassigned',
  updated_at = NOW()
WHERE btrim(coalesce(user_name, '')) = ''
   OR btrim(coalesce(assigned_to, '')) = '';

-- Post-check summary
SELECT user_name, COUNT(*)
FROM assets
GROUP BY user_name
ORDER BY COUNT(*) DESC, user_name;

COMMIT;
